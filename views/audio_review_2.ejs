<!DOCTYPE html>
<html>
    <head>
        <title>Audio transcription</title>
        <link rel="shortcut icon" type="image/png" href="/img/logoInlabSquare.png"/>
        <link href="/css/audio_review.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    </head>
    <body>
        <header>
          <%- include("header.ejs") %>
        </header>
        <br>
        <br>
        <div id="task-display">
            <h2><b>AUDIO TRANSCRIPTION REVIEW</b></h2>
            <div class="divide-line"></div>
            <div class="quickinfo">
                <p>ID Worker: 1</p>
                <p>ID Câu Hỏi: 1</p>
            </div>
            <audio id="review-audio" controls>
                <source id="audio-component" src="https://go.heartex.net/static/samples/game.wav" type="audio/wav">
                Your browser does not support the audio tag.
            </audio>
            <p id="labeled-transcription">Sáng hôm nay trời thật là đẹp</p>
        </div>
        <div id="task-review">
            <p><b>Đáp án này</b></p>
            <div class="radio-container">
                <div id="radio-true" class="radio-item">
                    <input type="radio" id="true" name="accepted" value="true" checked>
                    <label for="true"><div class="radio-text">Đúng</div></label><br>
                </div>
                <div id="radio-false" class="radio-item">
                    <input type="radio" id="false" name="accepted" value="false">
                    <label for="false"><div class="radio-text">Sai</div></label><br>
                </div>
            </div>
            
            
            
            <p><b>Văn bản chính xác</b></p>
            <div class="divide-line"></div>
            <textarea class="review-text" id="review-correct-text" name="review-correct-text" ></textarea>
            <p><b>Bình luận</b></p>
            <div class="divide-line"></div>
            <textarea class="review-text" id="review-comment" name="review-comment" ></textarea>
            <br>
            <input type="hidden" name="project_id" value="gotit">
            <br>
            <!-- <input type="submit" value="Submit"> -->
            <div class="justify-content-center d-flex pb-5">
                <button onclick="processSubmitButton()" class="contact btn btn-warning btn-lg btn-block">XÁC NHẬN</button>
            </div>
            
        </div>


        <script>
          var project_id = '<%= project_id%>'
          var reviewer_id = '<%= reviewer_id %>'
          var current_task_id = -1

          window.onload = async function() {
              var task = await loadNewTask(project_id);

          }

          function displayReceivedTask(task) {
              let audio_url = "http://inlab.nisci.gov.vn/" + task.url
              document.getElementById("audio-component").setAttribute("src", audio_url);
              document.getElementById("review-audio").load();
              document.getElementById("labeled-transcription").innerText = task.text;
              document.getElementById("review-correct-text").value = "";
              document.getElementById("review-comment").value = "";
          }

          async function loadNewTask() {
              setTimeout(function() {
                  console.log("Loading new task...")
              }, 1500);
              var task = {
                  url: "https://go.heartex.net/static/samples/game.wav",
                  text: "-M WHY DID YOU do That"
              }
              return task
          }

          async function sendReviewedTaskOf(project_id) {
              var rv_accepted = document.querySelector('input[name="accepted"]:checked').value;
              var rv_correct_text = document.getElementById("review-correct-text").value;
              var rv_comment = document.getElementById("review-comment").value;

              var data = {
                  review_id: current_task_id,
                  review_accepted: rv_accepted,
                  review_correct_text: rv_correct_text,
                  review_comment: rv_comment
              }

              console.log("data:", data);

              var url = '/review/project/' + project_id;
              console.log("url:", url)

              var otherParams = {
                  headers: {
                      "Content-Type": "application/json"
                  },
                  body: JSON.stringify(data),
                  method: "POST"
              }

              var response = await fetch(url, otherParams)

              console.log("response", response);

              return response
          }

          async function processSubmitButton() {
              sendReviewedTaskOf(project_id)
                  .then(async function(new_task){

                      document.querySelector('input[name="accepted"]').checked = false;
                      document.getElementById("review-correct-text").value = "";
                      document.getElementById("review-comment").value = "";

                      new_task = await new_task.json()
                      console.log("New task:", new_task);
                      if (new_task.code === "full") {
                          alert("Đã hết dữ liệu cần review, xin cảm ơn!");
                          return
                      }
                      if (new_task.code == 'ERROR') {
                          alert("ERROR HAPPENED");
                          return
                      }
                      current_task_id = new_task.id;
                      displayReceivedTask(new_task);
                  })
          }
          
      </script>

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    </body>
</html>